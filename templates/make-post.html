{% if is_edit %}
  {% set page_title = "WonderFloyd - Edit Post" %}
{% else %}
  {% set page_title = "WonderFloyd - New Post" %}
{% endif %}
{% set meta_description = "Create or edit WonderFloyd articles with rich text, cover images, categories and sources." %}
{% from "bootstrap5/form.html" import render_field %}
{% include "header.html" %}

<header class="masthead" style="background-image: url('{{ url_for('static', filename='assets/img/wf-bg-v5.png') }}')">
  <div class="container position-relative px-4 px-lg-5">
    <div class="row gx-4 gx-lg-5 justify-content-center">
      <div class="col-md-10 col-lg-8 col-xl-7">
        <div class="page-heading">
          {% if is_edit %}
          <h1>Edit Post</h1>
          {% else %}
          <h1>New Post</h1>
          {% endif %}
          <span class="page-subheading">You're going to make a great post!</span>
        </div>
      </div>
    </div>
  </div>
</header>

<main class="mb-4 wf-makepost">
  <div class="container">
    <div class="row">
      <div class="col-lg-8 col-md-10 mx-auto">

        <!-- Manual form layout for full control -->
        <form method="POST" enctype="multipart/form-data" novalidate>
          {{ form.hidden_tag() }}

          {{ render_field(form.title) }}
          {{ render_field(form.subtitle) }}
          {{ render_field(form.img_url) }}
          {{ render_field(form.cover_image) }}
          {{ render_field(form.body) }}
          {{ render_field(form.categories) }}

          <!-- COMPACT SOURCES CARD -->
          <div class="card wf-admin-sources my-4">
            <div class="card-header d-flex justify-content-between align-items-center">
              <strong>Sources</strong>
              <small class="text-muted">Label only is fine, add URL to make it clickable</small>
            </div>
            <div class="card-body">
              {% for sf in form.sources %}
                <div class="row g-2 align-items-center mb-2">
                  <div class="col-12 col-md-6">
                    {# use subform field; render input with placeholder #}
                    {{ sf.form.label(
                         class="form-control form-control-sm",
                         placeholder="Source material..") }}
                  </div>
                  <div class="col-12 col-md-6">
                    {{ sf.form.url(
                         class="form-control form-control-sm",
                         placeholder="https://example.com/...") }}
                  </div>
                </div>
              {% endfor %}
              <div class="form-text">Empty rows are ignored on save.</div>
            </div>
          </div>

          <div class="d-flex">
            {{ render_field(form.submit, button_style="primary") }}
          </div>
        </form>

      </div>
    </div>
  </div>
</main>

<script>
  (function () {
    const el = document.querySelector('textarea[name="body"]');
    if (!el) return;

    function initEditor() {
      const Editor = (window.CKEDITOR && CKEDITOR.ClassicEditor) || window.ClassicEditor;
      if (!Editor) { console.error('CKEditor not found after load'); return; }

      Editor.create(el, {
        // Keep Base64UploadAdapter (we convert on save in backend)
        removePlugins: [
          'CloudServices','EasyImage','ExportPdf','ExportWord','WProofreader','AIAssistant',
          'CKBox','CKBoxUtils','CKBoxImageEdit',
          'CKFinder','CKFinderUploadAdapter',
          'RealTimeCollaborativeComments','RealTimeCollaborativeTrackChanges',
          'RealTimeCollaborativeRevisionHistory','PresenceList','Comments',
          'TrackChanges','TrackChangesData','RevisionHistory',
          'MultiLevelList','TableOfContents','FormatPainter','Template',
          'SlashCommand','PasteFromOfficeEnhanced','CaseChange',
          'Pagination','DocumentOutline'
        ],
        toolbar: {
          items: [
            'undo','redo','|',
            'heading','|',
            'bold','italic','link','|',
            'bulletedList','numberedList','|',
            'imageInsert','blockQuote','codeBlock'
          ]
        },
        image: {
          insert: { integrations: ['upload', 'url'] },
          toolbar: [
            'imageStyle:alignLeft','imageStyle:alignCenter','imageStyle:alignRight',
            '|','toggleImageCaption','linkImage','imageTextAlternative'
          ],
          styles: [ 'alignLeft','alignCenter','alignRight' ]
        }
      })
      .then(() => console.log('CKEditor ready âœ…'))
      .catch(err => console.error('CKEditor init error:', err));
    }

    // Lazy-load only on this page
    if (!window.CKEDITOR && !window.ClassicEditor) {
      const s = document.createElement('script');
      s.src = 'https://cdn.ckeditor.com/ckeditor5/41.4.2/super-build/ckeditor.js';
      s.defer = true;
      s.onload = initEditor;
      document.head.appendChild(s);
    } else {
      initEditor();
    }
  })();
</script>

{% include "footer.html" %}
